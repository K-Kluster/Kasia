name: Build

on:
  push:
    branches:
      - staging
      - master
      # todo remove
      - chore/mobile

jobs:
  build-cipher-wasm:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # install rust
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: 1.86.0
          target: wasm32-unknown-unknown
          # key based on branch name
          cache-shared-key: cipher-wasm-build-cache-${{ github.ref_name }}
          cache-workspaces: ./cipher -> target

      - name: Build Cipher Wasm
        # install wasm-pack, move to ./cipher and build with wasm-pack
        run: |
          cargo install wasm-pack
          cd ./cipher
          wasm-pack build --target web --release -d ../cipher-wasm

      # Instead of relying on cache, let's use artifacts to store the wasm files
      - name: Upload Cipher Wasm artifact
        uses: actions/upload-artifact@v4
        with:
          name: cipher-wasm-${{ github.ref_name }}
          path: cipher-wasm
          if-no-files-found: error
          retention-days: 90
          overwrite: true

  build-web-app:
    runs-on: ubuntu-latest
    needs: build-cipher-wasm
    steps:
      - uses: actions/checkout@v4

      - name: Restore Cipher Wasm artifact
        uses: actions/download-artifact@v4
        with:
          name: cipher-wasm-${{ github.ref_name }}
          path: cipher-wasm
          if-no-files-found: error
# uses: dsaltares/fetch-gh-release-asset@master
# with:
#   repo: 'dsaltares/godot-wild-jam-18'
#   version: 'tags/v0.1.18'
#   file: 'plague-linux.zip'
#   token: ${{ secrets.GITHUB_TOKEN }}
